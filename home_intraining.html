<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Intraining Data</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://apis.google.com/js/platform.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    label {
      margin: 10px 0;
      display: block;
    }
    input {
      margin: 5px 0 15px 0;
      padding: 10px;
      font-size: 14px;
    }
    button {
      padding: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Search "Intraining - Thimbirigasyaya" Google Sheets</h1>

  <!-- Search Form -->
  <label for="contractNumber">Contract Number:</label>
  <input type="text" id="contractNumber" placeholder="Enter Contract Number">
  
  <label for="apprenticeName">Name of Apprentices:</label>
  <input type="text" id="apprenticeName" placeholder="Enter Apprentice Name">
  
  <label for="nic">NIC:</label>
  <input type="text" id="nic" placeholder="Enter NIC">
  
  <label for="dropout">Dropout:</label>
  <input type="text" id="dropout" placeholder="Enter Dropout Status">
  
  <label for="establishment">Name of the Establishment:</label>
  <input type="text" id="establishment" placeholder="Enter Establishment Name">
  
  <button id="searchBtn">Search</button>

  <!-- Display Results -->
  <h2>Search Results:</h2>
  <div id="results"></div>

  <script>
    const CLIENT_ID = '1012518567444-kg8cdrhj1nq41sc8v0notomkqf2v2b4b.apps.googleusercontent.com';  // Replace with your OAuth 2.0 Client ID
    const API_KEY = 'my-project-naita';  // Replace with your Google API Key
    const SPREADSHEET_ID = '11kW9rEvH0HRNPq37uZK_7eJjL1W08yDD'; // Spreadsheet ID from shared link
    const RANGE = 'Intraining -Thimbirigasyaya!A1:E'; // The range of cells in the sheet

    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';
    let isAuthenticated = false;

    // Initialize the API client
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        scope: SCOPES,
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
      }).then(function () {
        // Check if the user is already signed in
        if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
          isAuthenticated = true;
          document.getElementById('searchBtn').disabled = false;
        } else {
          document.getElementById('searchBtn').disabled = true;
        }
      });
    }

    // Handle authentication
    function authenticate() {
      gapi.auth2.getAuthInstance().signIn().then(function () {
        isAuthenticated = true;
        document.getElementById('searchBtn').disabled = false;
      });
    }

    // Load the spreadsheet data from Google Sheets
    function loadSpreadsheetData() {
      if (isAuthenticated) {
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE
        }).then(function(response) {
          const data = response.result.values;
          displaySearchResults(data);
        }, function(error) {
          console.error('Error loading spreadsheet data:', error);
        });
      } else {
        alert('Please sign in first.');
      }
    }

    // Filter and display search results
    function displaySearchResults(data) {
      const contractNumber = document.getElementById('contractNumber').value.toLowerCase();
      const apprenticeName = document.getElementById('apprenticeName').value.toLowerCase();
      const nic = document.getElementById('nic').value.toLowerCase();
      const dropout = document.getElementById('dropout').value.toLowerCase();
      const establishment = document.getElementById('establishment').value.toLowerCase();

      let filteredResults = data.filter(function(row) {
        return (contractNumber === '' || row[0].toLowerCase().includes(contractNumber)) &&
               (apprenticeName === '' || row[1].toLowerCase().includes(apprenticeName)) &&
               (nic === '' || row[2].toLowerCase().includes(nic)) &&
               (dropout === '' || row[3].toLowerCase().includes(dropout)) &&
               (establishment === '' || row[4].toLowerCase().includes(establishment));
      });

      const resultsContainer = document.getElementById('results');
      resultsContainer.innerHTML = ''; // Clear previous results

      if (filteredResults.length > 0) {
        filteredResults.forEach(function(row) {
          const resultItem = document.createElement('p');
          resultItem.innerHTML = `Contract Number: ${row[0]}, Name of Apprentice: ${row[1]}, NIC: ${row[2]}, Dropout: ${row[3]}, Establishment: ${row[4]}`;
          resultsContainer.appendChild(resultItem);
        });
      } else {
        resultsContainer.innerHTML = '<p>No matching results found.</p>';
      }
    }

    // Load the Google API client and authenticate
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    // Event listener for search button
    document.getElementById('searchBtn').addEventListener('click', loadSpreadsheetData);

    // Initialize the client when the page loads
    window.onload = handleClientLoad;
  </script>

</body>
</html>
